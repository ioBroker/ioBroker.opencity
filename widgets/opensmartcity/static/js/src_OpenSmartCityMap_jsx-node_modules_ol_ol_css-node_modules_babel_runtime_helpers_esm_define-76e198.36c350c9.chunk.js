"use strict";(self.webpackChunkiobroker_opensmartcity=self.webpackChunkiobroker_opensmartcity||[]).push([["src_OpenSmartCityMap_jsx-node_modules_ol_ol_css-node_modules_babel_runtime_helpers_esm_define-76e198"],{57113:(t,e,i)=>{i.r(e),i.d(e,{default:()=>p});i(4819);var s=i(15854),o=i.n(s),a=i(12181),n=i(88411),r=i(72093),h=i(80184);const c=window.visRxWidget||n.VisRxWidget;class l extends c{constructor(t){super(t),this.onDataUpdated=(t,e)=>{const i={...this.state.values};i[t]=e,this.setState({values:i,points:l.buildPoints(this.state.things,this.state.dataStreams,i)})},this.onPointsChanged=(t,e)=>{if(e){if("channel"===e.type){const i={...this.state.things};i[t]=e,this.setState({things:i,points:l.buildPoints(i,this.state.dataStreams,this.state.values)})}else if("state"===e.type){const i={...this.state.dataStreams};i[t]=e,this.setState({dataStreams:i,points:l.buildPoints(this.state.things,i,this.state.values)})}}else if(this.state.things[t]){const e={...this.state.things};delete e[t],this.setState({things:e,points:l.buildPoints(e,this.state.dataStreams,this.state.values)})}else if(this.state.dataStreams[t]){const e={...this.state.dataStreams};delete e[t],this.setState({dataStreams:e,points:l.buildPoints(this.state.things,e,this.state.values)})}},this.state._key=0,this.hideHome=null}static getWidgetInfo(){return{id:"tplOpenSmartCityMap",visSet:"opensmartcity",visSetLabel:"set_label",visSetColor:"#dcca19",visWidgetLabel:"OpenSmartCityMap",visName:"OpenSmartCityMap",visAttrs:[{name:"common",fields:[{name:"noCard",label:"without_card",type:"checkbox",default:!1},{name:"widgetTitle",label:"name",hidden:"!!data.noCard"},{label:"instance",name:"instance",type:"instance",adapter:"opensmartcity"},{name:"hideHome",label:"hide_home",type:"checkbox"},{label:"zoom_level",name:"zoomLevel",type:"slider",min:-1,max:17,default:0}]}],visDefaultStyle:{width:"100%",height:300,position:"relative"},visPrev:"widgets/opensmartcity/img/prev_opensmartcity.png"}}getWidgetInfo(){return l.getWidgetInfo()}static buildPoints(t,e,i){return Object.keys(t).map((s=>{const o=t[s];return o.native&&o.native.coordinates&&o.native.coordinates.length?{longitude:o.native.coordinates[0],latitude:o.native.coordinates[1],name:o.common.name&&"object"===typeof o.common.name?o.common.name[this.props.context.lang]||o.common.name.en:o.common.name||"",description:o.common.desc&&"object"===typeof o.common.desc?o.common.desc[this.props.context.lang]||o.common.desc.en:o.common.desc||"",dataStreams:Object.keys(e).filter((t=>t.startsWith("".concat(s,".")))).map((t=>({id:t.split(".").pop(),name:e[t].common.name,description:e[t].common.desc,value:i[t]&&void 0!==i[t].val?i[t].val:null,unit:e[t].common.unit||""})))}:null})).filter((t=>t))}async propertiesUpdate(){const t="".concat(this.state.rxData.instance,".*");if(this.subscribed&&this.subscribed!==t&&(this.props.context.socket.unsubscribeObject(this.subscribed,this.onPointsChanged),await this.props.context.socket.unsubscribeStates(this.subscribed,this.onDataUpdated),this.subscribed=null),null!==this.state.rxData.instance&&void 0!==this.state.rxData.instance&&this.subscribed!==t){this.subscribed=t;const e=await this.props.context.socket.getObjectViewSystem("channel",this.subscribed.replace(/\*$/,""),"".concat(this.subscribed.replace(/\*$/,""),"\u9999")),i=await this.props.context.socket.getObjectViewSystem("state",this.subscribed.replace(/\*$/,""),"".concat(this.subscribed.replace(/\*$/,""),"\u9999")),s=await this.props.context.socket.getForeignStates(this.subscribed);this.setState({things:e,values:s,dataStreams:i,points:l.buildPoints(e,i,s)},(async()=>{await this.props.context.socket.subscribeObject(this.subscribed,this.onPointsChanged),await this.props.context.socket.subscribeState(this.subscribed,this.onDataUpdated)}))}}static getI18nPrefix(){return"opensmartcity_"}async componentDidMount(){super.componentDidMount(),await this.propertiesUpdate()}async componentWillUnmount(){this.subscribed&&(await this.props.context.socket.unsubscribeObject(this.subscribed,this.onPointsChanged),await this.props.context.socket.unsubscribeState(this.subscribed,this.onDataUpdated),this.subscribed=null)}onRxDataChanged(){this.propertiesUpdate()}renderWidgetBody(t){super.renderWidgetBody(t),null===this.hideHome?this.hideHome=this.state.rxData.hideHome:this.hideHome!==this.state.rxData.hideHome&&(this.hideHome=this.state.rxData.hideHome,setTimeout((()=>this.setState({_key:this.state._key+1})),100));const e=(0,h.jsx)(r.Z,{socket:this.props.context.socket,id:"map_".concat(this.props.id),things:this.state.points||[],hideHome:this.state.rxData.hideHome},this.state._key);return this.state.rxData.noCard?e:this.wrapContent(e)}}l.propTypes={context:o().object,themeType:o().string,style:o().object,data:o().object};const p=(0,a.withStyles)((()=>({content:{display:"flex",width:"100%",height:"100%"}})))((0,a.withTheme)(l))},72093:(t,e,i)=>{i.d(e,{Z:()=>x});i(4847);var s=i(54765),o=i(10430),a=i(62652),n=i(37130),r=i(57659),h=i(57707),c=i(64665),l=i(18029),p=i(69236),d=i(90927),m=i(29901),u=i(21370),g=i(29409),b=i(60724),S=i(4819),f=i(75606),v=i(80184);const y="data:image/svg+xml;utf8,".concat(encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">\n    <path fill="#00F" d="M360-440h80v-110h80v110h80v-190l-120-80-120 80v190Zm120 254q122-112 181-203.5T720-552q0-109-69.5-178.5T480-800q-101 0-170.5 69.5T240-552q0 71 59 162.5T480-186Zm0 106Q319-217 239.5-334.5T160-552q0-150 96.5-239T480-880q127 0 223.5 89T800-552q0 100-79.5 217.5T480-80Zm0-480Z"/>\n</svg>')),w="data:image/svg+xml;utf8,".concat(encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48">\n    <path fill="#080" d="M480-120q-75.53 0-128.765-53.235Q298-226.47 298-302q0-49.099 24-91.55Q346-436 388-462v-286q0-38.333 26.765-65.167 26.764-26.833 65-26.833Q518-840 545-813.167q27 26.834 27 65.167v286q42 26 66 68.45 24 42.451 24 91.55 0 75.53-53.235 128.765Q555.53-120 480-120Zm.118-59Q531-179 566.5-214.875 602-250.75 602-302q0-37.81-18-70.405T532-420l-20-9v-319q0-13.6-9.2-22.8-9.2-9.2-22.8-9.2-13.6 0-22.8 9.2-9.2 9.2-9.2 22.8v319l-20 9q-34 15-52 47.595T358-302q0 51.25 35.618 87.125Q429.235-179 480.118-179ZM480-302Z"/>\n</svg>'));class M extends S.Component{constructor(t){super(t),this.state={longitude:0,latitude:0,things:[...this.props.things],mapHeight:0,mapWidth:0},this.refMap=(0,S.createRef)()}calculateZoomLevel(t){var e;const i=(0,b.mi)([parseFloat(this.state.longitude||0),parseFloat(this.state.latitude||0)]);if(null===(e=this.state.things)||void 0===e||!e.length)return 17;let s;if(this.props.hideHome){const t=(0,b.mi)([this.state.things[0].longitude,this.state.things[0].latitude]);s=(0,n.T9)(t[0],t[1],t[0],t[1])}else s=(0,n.T9)(i[0],i[1],i[0],i[1]);return this.state.things.forEach(((t,e)=>{if(!e&&this.props.hideHome)return;const i=(0,b.mi)([t.longitude,t.latitude]);(0,n.l7)(s,[i[0],i[1],i[0],i[1]])})),t.getView().fit(s,t.getSize()),t.getView().getZoom()-1}calculateCenter(){let t=this.props.hideHome?0:1,e=this.props.hideHome?0:parseFloat(this.state.longitude||0),i=this.props.hideHome?0:parseFloat(this.state.latitude||0);return this.state.things.forEach((s=>{e+=s.longitude,i+=s.latitude,t++})),(0,b.mi)([e/t,i/t])}displayTooltip(t,e){const i=e.closest(".ol-control")?void 0:this.OSM.oMap.forEachFeatureAtPixel(t,(t=>t));if(i){this.hideTimer&&clearTimeout(this.hideTimer);const e={left:t[0],top:t[1],text:i.get("name")};this.setState({tooltip:e})}else this.hideTimer&&clearTimeout(this.hideTimer),this.hideTimer=setTimeout((()=>this.setState({tooltip:null})),500)}updateMap(){const t=(0,b.mi)([parseFloat(this.state.longitude||0),parseFloat(this.state.latitude||0)]);if(!this.OSM){this.OSM={},this.props.hideHome||(this.OSM.markerSource=new m.Z),this.OSM.pointsSource=new m.Z,this.OSM.markerStyle=new c.ZP({image:new l.Z({anchor:[.5,49],anchorXUnits:"fraction",anchorYUnits:"pixels",opacity:.75,src:y})}),this.OSM.tempStyle=new c.ZP({image:new l.Z({anchor:[.5,49],anchorXUnits:"fraction",anchorYUnits:"pixels",opacity:.75,src:w})}),this.OSM.pointsLayer=new r.Z({source:this.OSM.pointsSource,style:this.OSM.tempStyle});const e=[new h.Z({source:new u.Z}),this.OSM.pointsLayer];this.props.hideHome||e.push(new r.Z({source:this.OSM.markerSource,style:this.OSM.markerStyle})),this.OSM.oMap=new s.Z({target:this.props.id||"map",layers:e,view:new o.ZP({center:t,zoom:17})}),this.props.hideHome||(this.OSM.marker=new a.Z({geometry:new g.Z(t),name:f.I18n.t("Your home")}),this.OSM.markerSource.addFeature(this.OSM.marker)),this.OSM.oMap.on("pointermove",(t=>{if(t.dragging)return void(this.state.tooltip&&this.setState({tooltip:null}));const e=this.OSM.oMap.getEventPixel(t.originalEvent);this.displayTooltip(e,t.originalEvent.target)})),this.OSM.oMap.on("singleclick",(t=>{const e=this.OSM.oMap.getEventPixel(t.originalEvent),i=this.OSM.oMap.forEachFeatureAtPixel(e,(t=>t));this.props.onSelect&&i&&this.props.onSelect(i.get("name"))}))}this.OSM.pointsSource.clear();for(let e=0;e<this.state.things.length;e++){const t=this.state.things[e],i=new a.Z({geometry:new g.Z((0,b.mi)([t.longitude,t.latitude])),name:t.name}),s=[];t.dataStreams.forEach((t=>{console.log(t),void 0!==t.value&&null!==t.value&&s.push((Math.round(10*t.value)/10).toString()+(t.unit||""))}));const o=new c.ZP({image:new l.Z({anchor:[.5,49],anchorXUnits:"fraction",anchorYUnits:"pixels",opacity:.75,src:w}),text:new p.Z({text:s.join("\n"),scale:1.2,fill:new d.Z({color:"#004f00"})})});i.setStyle(o),this.OSM.pointsSource.addFeature(i)}this.props.hideHome||this.OSM.marker.setGeometry(new g.Z(t)),this.OSM.oMap.setView(new o.ZP({center:this.calculateCenter(),zoom:this.calculateZoomLevel(this.OSM.oMap)}))}componentDidMount(){this.props.socket.getSystemConfig().then((t=>this.setState({longitude:t.common.longitude,latitude:t.common.latitude},(()=>{var t;return(null===(t=this.refMap.current)||void 0===t?void 0:t.clientHeight)&&this.updateMap()}))))}componentDidUpdate(){this.refMap.current&&this.refMap.current.clientWidth!==this.state.mapWidth&&this.refMap.current.clientHeight!==this.state.mapHeight&&(this.OSM?this.setState({mapWidth:this.refMap.current.clientWidth,mapHeight:this.refMap.current.clientHeight},(()=>this.OSM.oMap.updateSize())):this.setState({mapWidth:this.refMap.current.clientWidth,mapHeight:this.refMap.current.clientHeight},(()=>setTimeout((()=>this.updateMap()),10))))}renderTooltip(){return this.state.tooltip?(0,v.jsx)("div",{style:{position:"absolute",top:this.state.tooltip.top,left:this.state.tooltip.left,color:"#000",padding:"3px 5px",backgroundColor:"#fff",borderRadius:5},children:this.state.tooltip.text},"tooltip"):null}render(){return JSON.stringify(this.props.things)!==JSON.stringify(this.state.things)&&this.OSM&&setTimeout((()=>this.setState({things:[...this.props.things]},(()=>{var t;return(null===(t=this.refMap.current)||void 0===t?void 0:t.clientWidth)&&this.updateMap()}))),100),[(0,v.jsx)("div",{ref:this.refMap,id:this.props.id||"map",style:{height:"100%",width:"100%",overflow:"hidden"}},"map"),this.renderTooltip()]}}const x=M},4942:(t,e,i)=>{i.d(e,{Z:()=>o});var s=i(72881);function o(t,e,i){return(e=(0,s.Z)(e))in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}},72881:(t,e,i)=>{function s(t){return s="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},s(t)}function o(t){var e=function(t,e){if("object"!=s(t)||!t)return t;var i=t[Symbol.toPrimitive];if(void 0!==i){var o=i.call(t,e||"default");if("object"!=s(o))return o;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==s(e)?e:String(e)}i.d(e,{Z:()=>o})}}]);
//# sourceMappingURL=src_OpenSmartCityMap_jsx-node_modules_ol_ol_css-node_modules_babel_runtime_helpers_esm_define-76e198.36c350c9.chunk.js.map