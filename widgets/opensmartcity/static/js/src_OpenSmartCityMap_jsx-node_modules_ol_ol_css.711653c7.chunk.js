/*! For license information please see src_OpenSmartCityMap_jsx-node_modules_ol_ol_css.711653c7.chunk.js.LICENSE.txt */
"use strict";(self.webpackChunkiobroker_opensmartcity=self.webpackChunkiobroker_opensmartcity||[]).push([["src_OpenSmartCityMap_jsx-node_modules_ol_ol_css","node_modules_react_jsx-runtime_js"],{57113:(t,e,i)=>{i.r(e),i.d(e,{default:()=>l});i(4819);var s=i(15854),o=i.n(s),a=i(58503),n=i(88411),r=i(72093),p=i(80184);const c=window.visRxWidget||n.VisRxWidget;class h extends c{constructor(){super(...arguments),this.onDataUpdated=(t,e)=>{const i={...this.state.values};i[t]=e,this.setState({values:i,points:h.buildPoints(this.state.things,i)})},this.onPointsChanged=()=>this.propertiesUpdate()}static getWidgetInfo(){return{id:"tplOpenSmartCityMap",visSet:"opensmartcity",visSetLabel:"set_label",visSetColor:"#dcca19",visWidgetLabel:"OpenSmartCityMap",visName:"OpenSmartCityMap",visAttrs:[{name:"common",fields:[{name:"noCard",label:"without_card",type:"checkbox",default:!1},{name:"widgetTitle",label:"name",hidden:"!!data.noCard"},{label:"instance",name:"instance",type:"instance",adapter:"opensmartcity"},{name:"hideHome",label:"hide_home",type:"checkbox"},{label:"zoom_level",name:"zoomLevel",type:"slider",min:-1,max:17,default:0}]}],visDefaultStyle:{width:"100%",height:300,position:"relative"},visPrev:"widgets/opensmartcity/img/prev_opensmartcity.png"}}getWidgetInfo(){return h.getWidgetInfo()}static buildPoints(t,e){return Object.keys(t).map((i=>{const s=t[i];return{longitude:s.native.coordinates[0],latitude:s.native.coordinates[1],unit:s.common.unit,value:e[i]?e[i].val:"--",name:s.common.name&&"object"===typeof s.common.name?s.common.name[this.props.context.lang]||s.common.name.en:s.common.name||""}}))}async propertiesUpdate(){const t="system.adapter.opensmartcity.".concat(this.state.rxData.instance);if(this.subscribed&&this.subscribed!==t&&(this.props.context.socket.unsubscribeObject(this.subscribed,this.onPointsChanged),await this.props.context.socket.unsubscribeStates("".concat(this.subscribed.replace("system.adapter.",""),".*"),this.onDataUpdated),this.subscribed=null),null!==this.state.rxData.instance&&void 0!==this.state.rxData.instance&&this.subscribed!==t){this.subscribed=t;const e=await this.props.context.socket.getObjectViewSystem("state","opensmartcity.".concat(this.state.rxData.instance,"."),"opensmartcity.".concat(this.state.rxData.instance,".\u9999")),i=await this.props.context.socket.getStates("".concat(this.subscribed.replace("system.adapter.",""),".*"));this.setState({things:e,values:i,points:h.buildPoints(e,i)},(async()=>{await this.props.context.socket.subscribeObject("system.adapter.opensmartcity.".concat(this.state.rxData.instance),this.onPointsChanged),await this.props.context.socket.subscribeState("".concat(this.subscribed.replace("system.adapter.",""),".*"),this.onDataUpdated)}))}}static getI18nPrefix(){return"opensmartcity_"}async componentDidMount(){super.componentDidMount(),await this.propertiesUpdate()}async componentWillUnmount(){this.subscribed&&(await this.props.context.socket.unsubscribeObject(this.subscribed,this.onPointsChanged),await this.props.context.socket.unsubscribeState("".concat(this.subscribed.replace("system.adapter.",""),".*"),this.onDataUpdated),this.subscribed=null)}onRxDataChanged(){this.propertiesUpdate()}renderWidgetBody(t){super.renderWidgetBody(t);const e=(0,p.jsx)(r.Z,{socket:this.props.context.socket,id:"map_".concat(this.props.id),points:this.state.points||[],hideHome:this.state.rxData.hideHome});return this.state.rxData.noCard?e:this.wrapContent(e)}}h.propTypes={context:o().object,themeType:o().string,style:o().object,data:o().object};const l=(0,a.withStyles)((()=>({content:{display:"flex",width:"100%",height:"100%"}})))((0,a.withTheme)(h))},72093:(t,e,i)=>{i.d(e,{Z:()=>x});i(4847);var s=i(54765),o=i(10430),a=i(62652),n=i(37130),r=i(68557),p=i(57707),c=i(64665),h=i(38920),l=i(69236),d=i(90927),m=i(29901),u=i(21370),g=i(29409),S=i(60724),y=i(4819),f=i(75606),v=i(80184);const b="data:image/svg+xml;utf8,".concat(encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 -960 960 960" width="24">\n    <path fill="#00F" d="M360-440h80v-110h80v110h80v-190l-120-80-120 80v190Zm120 254q122-112 181-203.5T720-552q0-109-69.5-178.5T480-800q-101 0-170.5 69.5T240-552q0 71 59 162.5T480-186Zm0 106Q319-217 239.5-334.5T160-552q0-150 96.5-239T480-880q127 0 223.5 89T800-552q0 100-79.5 217.5T480-80Zm0-480Z"/>\n</svg>')),M="data:image/svg+xml;utf8,".concat(encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" height="48" viewBox="0 -960 960 960" width="48">\n    <path fill="#080" d="M480-120q-75.53 0-128.765-53.235Q298-226.47 298-302q0-49.099 24-91.55Q346-436 388-462v-286q0-38.333 26.765-65.167 26.764-26.833 65-26.833Q518-840 545-813.167q27 26.834 27 65.167v286q42 26 66 68.45 24 42.451 24 91.55 0 75.53-53.235 128.765Q555.53-120 480-120Zm.118-59Q531-179 566.5-214.875 602-250.75 602-302q0-37.81-18-70.405T532-420l-20-9v-319q0-13.6-9.2-22.8-9.2-9.2-22.8-9.2-13.6 0-22.8 9.2-9.2 9.2-9.2 22.8v319l-20 9q-34 15-52 47.595T358-302q0 51.25 35.618 87.125Q429.235-179 480.118-179ZM480-302Z"/>\n</svg>'));class w extends y.Component{constructor(t){super(t),this.state={longitude:0,latitude:0,points:[...this.props.points],mapHeight:0,mapWidth:0},this.refMap=(0,y.createRef)()}calculateZoomLevel(t){var e;const i=(0,S.mi)([parseFloat(this.state.longitude||0),parseFloat(this.state.latitude||0)]);if(null===(e=this.state.points)||void 0===e||!e.length)return 17;let s;if(this.props.hideHome){const t=(0,S.mi)([this.state.points[0].longitude,this.state.points[0].latitude]);s=(0,n.T9)(t[0],t[1],t[0],t[1])}else s=(0,n.T9)(i[0],i[1],i[0],i[1]);return this.state.points.forEach(((t,e)=>{if(!e&&this.props.hideHome)return;const i=(0,S.mi)([t.longitude,t.latitude]);(0,n.l7)(s,[i[0],i[1],i[0],i[1]])})),t.getView().fit(s,t.getSize()),t.getView().getZoom()-1}calculateCenter(){let t=this.props.hideHome?0:1,e=this.props.hideHome?0:parseFloat(this.state.longitude||0),i=this.props.hideHome?0:parseFloat(this.state.latitude||0);return this.state.points.forEach((s=>{e+=s.longitude,i+=s.latitude,t++})),(0,S.mi)([e/t,i/t])}displayTooltip(t,e){const i=e.closest(".ol-control")?void 0:this.OSM.oMap.forEachFeatureAtPixel(t,(t=>t));if(i){this.hideTimer&&clearTimeout(this.hideTimer);const e={left:t[0],top:t[1],text:i.get("name")};this.setState({tooltip:e})}else this.hideTimer&&clearTimeout(this.hideTimer),this.hideTimer=setTimeout((()=>this.setState({tooltip:null})),500)}updateMap(){const t=(0,S.mi)([parseFloat(this.state.longitude||0),parseFloat(this.state.latitude||0)]);this.OSM||(this.OSM={},this.OSM.markerSource=new m.Z,this.OSM.pointsSource=new m.Z,this.OSM.markerStyle=new c.ZP({image:new h.Z({anchor:[.5,49],anchorXUnits:"fraction",anchorYUnits:"pixels",opacity:.75,src:b})}),this.OSM.tempStyle=new c.ZP({image:new h.Z({anchor:[.5,49],anchorXUnits:"fraction",anchorYUnits:"pixels",opacity:.75,src:M})}),this.OSM.pointsLayer=new r.Z({source:this.OSM.pointsSource,style:this.OSM.tempStyle}),this.OSM.oMap=new s.Z({target:this.props.id||"map",layers:[new p.Z({source:new u.Z}),new r.Z({source:this.OSM.markerSource,style:this.OSM.markerStyle}),this.OSM.pointsLayer],view:new o.ZP({center:t,zoom:17})}),this.OSM.marker=new a.Z({geometry:new g.Z(t),name:f.I18n.t("Your home")}),this.OSM.markerSource.addFeature(this.OSM.marker),this.OSM.oMap.on("pointermove",(t=>{if(t.dragging)return void(this.state.tooltip&&this.setState({tooltip:null}));const e=this.OSM.oMap.getEventPixel(t.originalEvent);this.displayTooltip(e,t.originalEvent.target)})),this.OSM.oMap.on("singleclick",(t=>{const e=this.OSM.oMap.getEventPixel(t.originalEvent),i=this.OSM.oMap.forEachFeatureAtPixel(e,(t=>t));this.props.onSelect&&i&&this.props.onSelect(i.get("name"))}))),this.OSM.pointsSource.clear();for(let e=0;e<this.state.points.length;e++){const t=this.state.points[e],i=new a.Z({geometry:new g.Z((0,S.mi)([t.longitude,t.latitude])),name:t.name}),s=new c.ZP({image:new h.Z({anchor:[.5,49],anchorXUnits:"fraction",anchorYUnits:"pixels",opacity:.75,src:M}),text:new l.Z({text:(Math.round(10*t.value)/10).toString()+t.unit,scale:1.2,fill:new d.Z({color:"#004f00"})})});i.setStyle(s),this.OSM.pointsSource.addFeature(i)}this.OSM.marker.setGeometry(new g.Z(t)),this.OSM.oMap.setView(new o.ZP({center:this.calculateCenter(),zoom:this.calculateZoomLevel(this.OSM.oMap)}))}componentDidMount(){this.props.socket.getSystemConfig().then((t=>this.setState({longitude:t.common.longitude,latitude:t.common.latitude},(()=>{var t;return(null===(t=this.refMap.current)||void 0===t?void 0:t.clientHeight)&&this.updateMap()}))))}componentDidUpdate(){this.refMap.current&&this.refMap.current.clientWidth!==this.state.mapWidth&&this.refMap.current.clientHeight!==this.state.mapHeight&&(this.OSM?this.setState({mapWidth:this.refMap.current.clientWidth,mapHeight:this.refMap.current.clientHeight},(()=>this.OSM.oMap.updateSize())):this.setState({mapWidth:this.refMap.current.clientWidth,mapHeight:this.refMap.current.clientHeight},(()=>setTimeout((()=>this.updateMap()),10))))}renderTooltip(){return this.state.tooltip?(0,v.jsx)("div",{style:{position:"absolute",top:this.state.tooltip.top,left:this.state.tooltip.left,color:"#000",padding:"3px 5px",backgroundColor:"#fff",borderRadius:5},children:this.state.tooltip.text},"tooltip"):null}render(){return JSON.stringify(this.props.points)!==JSON.stringify(this.state.points)&&this.OSM&&setTimeout((()=>this.setState({points:[...this.props.points]},(()=>{var t;return(null===(t=this.refMap.current)||void 0===t?void 0:t.clientWidth)&&this.updateMap()}))),100),[(0,v.jsx)("div",{ref:this.refMap,id:this.props.id||"map",style:{height:"100%",width:"100%",overflow:"hidden"}},"map"),this.renderTooltip()]}}const x=w},66374:(t,e,i)=>{var s=i(4819),o=Symbol.for("react.element"),a=Symbol.for("react.fragment"),n=Object.prototype.hasOwnProperty,r=s.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,p={key:!0,ref:!0,__self:!0,__source:!0};function c(t,e,i){var s,a={},c=null,h=null;for(s in void 0!==i&&(c=""+i),void 0!==e.key&&(c=""+e.key),void 0!==e.ref&&(h=e.ref),e)n.call(e,s)&&!p.hasOwnProperty(s)&&(a[s]=e[s]);if(t&&t.defaultProps)for(s in e=t.defaultProps)void 0===a[s]&&(a[s]=e[s]);return{$$typeof:o,type:t,key:c,ref:h,props:a,_owner:r.current}}e.Fragment=a,e.jsx=c,e.jsxs=c},80184:(t,e,i)=>{t.exports=i(66374)}}]);
//# sourceMappingURL=src_OpenSmartCityMap_jsx-node_modules_ol_ol_css.711653c7.chunk.js.map